<style>
  /* Set the size of the div element that contains the map */
  #map {
    height: 400px;
    /* The height is 400 pixels */
    width: 100%;
    /* The width is the width of the web page */
  }
</style>
<input type="file" id="fileUpload" multiple />
<input type="button" id="upload" value="Upload" onclick="Upload()" onselect="ength()" />
<input type="button" value="find" id="find">
<hr />
<div id="map"></div>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/xlsx.full.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.13.5/jszip.js"></script>
<script src='http://code.jquery.com/jquery-1.9.1.min.js'></script>

<script type="text/javascript">

  // initialising array which will store all results
  var result = [];

  // This function gets the total count of instances of a postcode. Can be used for multiple uploads
  var eventify = function (arr, callback) {
      arr.push = function (e) {
        Array.prototype.push.call(arr, e);
        callback(arr);
      };
    };
// this fuction will be used later when we add markers/heatmaps to the map
    eventify(result, function (updatedArr) {
      return updatedArr.length;
    });

  function Upload() {
    //Reference the FileUpload element.
    var fileUpload = document.getElementById("fileUpload");


    // If it is an excel file, run the process excel function inside Upload()
    var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.xls|.xlsx)$/;
    if (regex.test(fileUpload.value.toLowerCase())) {
      if (typeof FileReader != "undefined") {
        var reader = new FileReader();

        //For Browsers other than IE.
        if (reader.readAsBinaryString) {
          reader.onload = function (e) {
            ProcessExcel(e.target.result);
          };
          reader.readAsBinaryString(fileUpload.files[0]);

          // reader.readAsArrayBuffer(fileUpload.files[0]);
        }
      } else {
        alert("This browser does not support HTML5.");
      }
    } else {
      // if not then process the files as regular csv or txt files
      var results = []
      const reader = new FileReader();
      reader.onload = function () {
        // split the lines at new line breaks for txt, pass it into the function the map to current
        const lines = reader.result.split("\n").map(function (line) {
          // further split the file by comma
          var current = line.split(",");
          // check if the postcode is valid
          var regex = /[A-Z]{1,2}[0-9]{1,2} ?[0-9][A-Z]{2}/i;
          var match = regex.exec(current);

          if (match != null) {
            match = regex.exec(line);
            // pushes result to result array
            result.push(match[0]);
            // ength(match);
          }
          return current;
          console.log(result);

        });
      };
      reader.readAsText(fileUpload.files[0]);
      // return result;
    }
  }

  console.log(result);

  function ProcessExcel(data) {
    //Read the Excel File data.
    var workbook = XLSX.read(data, {
      type: "binary",
    });

    //Fetch the name of First Sheet.
    var firstSheet = workbook.SheetNames[0];

    //Read all rows from First Sheet into an JSON array.

    var excelRows = XLSX.utils.sheet_to_row_object_array(
      workbook.Sheets[firstSheet]
    );

    //Add the data rows from Excel file.

    // TODO clean this up
    for (var i = 0; i < excelRows.length; i++) {
      var cell = excelRows[i];
      // console.log(cell);
      if (cell.postcode) {
        var postcodes = [cell.postcode];
      } else if (cell.Postcode) {
        var postcodes = [cell.Postcode];
      } else if (cell["post code"]) {
        var postcodes = [cell["post code"]];
      } else if (cell["Post code"]) {
        var postcodes = [cell["Post code"]];
      }

      var regex = /^[A-Z]{1,2}[0-9]{1,2} ?[0-9][A-Z]{2}$/i;
      if (regex.test(postcodes)) {
        // validates postcodes and pushes to array
        result.push(postcodes.toString());
      } else {
        postcodes.pop(postcodes[i]);
      }
    }
  }

  var button = document.getElementById("find");
  var leng;

  // incomplete but initialises map and puts markers on
  // TODO make the markers work with geocoder & heatmap visualisations
  async function initMap() {

    // this took some tinkering but it can finally add markers to the map dynamically after the page has loaded
    // updatedArray stores the data, accessed later with the iterator
    // then it is just travelling down JSON. first by accessing results, then geometry and location of the google api json call
    eventify(result, function(updatedArr){
      
      for (var i = 0; i < updatedArr.length; i++) {
        $.post('https://maps.googleapis.com/maps/api/geocode/json?address=' + updatedArr[i] + '&key=AIzaSyC6xrYHhT-_CeoktqgAwGjbOCNrmVUkXno', null, function (data) {
          console.log(data);
          var p = data.results[0].geometry.location;
          new google.maps.Marker({
            position: p,
            map: map
          });

        });
      }
    });
    // initialising and giving options to the map
    var map;

    var myOptions = {
      zoom: 9,
      center: new google.maps.LatLng(51.509865, -0.118092),
      mapTypeId: 'terrain'
    };
    map = new google.maps.Map($('#map')[0], myOptions);

  }

</script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6xrYHhT-_CeoktqgAwGjbOCNrmVUkXno&libraries=visualization&callback=initMap">
  </script>
